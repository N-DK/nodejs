<div class="d-block text-center page-header shop">
    <h1 style="font-size: 55px;" class="font--primary text-white">Shop</h1>
    <div class="router--detail color--white--no-hover pb-4 text-center pt-4">
        <a href="/" class="color--white text-decoration-none">Home </a>/
        <span class="text-capitalize">Shop</span>
    </div>
</div>
<div class="pt-4">
    <div class="container mt-5">
        <div class="row">
            <div class="col-3">
                <div class="sidebar">
                    <div class="sidebar__items mb-5">
                        <h4 class="font--primary mb-5">Categories</h4>
                        <ul class="mt-4 p-0">
                            {{#each (getCategory products)}}
                            <li class="d-flex color--light--no-hover mb-3">
                                <a class="text-dark text--dark-hover text-decoration-none flex-grow-1" href="/product/category/{{this.slug}}">{{this.name}}</a>
                                <span>({{this.quantify}})</span>
                            </li>
                            {{/each}}
                        </ul>
                    </div>
                    <div class="sidebar__items">
                        <h4 class="font--primary mb-5">Product tags</h4>
                        <ul class="mt-4 p-0 d-flex flex-wrap">
                            <li class="me-2"> 
                                <a href="#" class="bg--white--hover border--primary text-decoration-none color--light pt-2 pb-2 pe-3 ps-3 lh-1 d-inline-block">Life Style</a>
                            </li>
                            <li class="me-2">
                                <a href="#" class="bg--white--hover border--primary text-decoration-none color--light pt-2 pb-2 pe-3 ps-3 lh-1 d-inline-block">Trend</a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="col-9">
                <div class="shop">
                    <div class="d-flex justify-content-between mb-4 align-items-center">
                        <p class="color--light--no-hover mb-0">There are <span class="text-dark">{{lengthArr products}} products</span> available</p>
                        <div class="d-flex align-items-center">
                            <div class="me-5 color--light--no-hover">
                                <span class="text-dark me-2">Show</span>
                                <span class="text-dark me-2">12</span>
                                <span class="me-2">24</span>
                                <span>All</span>
                            </div>
                            <div class="border--primary position-relative">
                                <select style="outline: none; padding: 40px; padding-left: 30px" name="" id="" class="w-100 border-0 pt-2 pb-2">
                                    <option value="">Sort By Default sorting</option>
                                    <option value="">Sort By Default sorting</option>
                                    <option value="">Sort By Default sorting</option>
                                    <option value="">Sort By Default sorting</option>
                                </select>
                                <i class="fa-solid fa-caret-down position-absolute top-50 translate-middle-y end-0 pe-3"></i>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        {{#each products}}
                        <div class="col-4">
                            <div class="product">
                                <div class="position-relative overflow-hidden">
                                    <a class="" href="/product/{{this.slug}}">
                                        <img class="w-100 h-100" src="{{this.image}}" alt="">
                                    </a>
                                    <button class="add-to-cart position-absolute start-50 bottom-0 mb-4 pt-3 pb-3 btn--primary text-uppercase border-0 z-n1" data-id="{{this._id}}" data-bs-target="#modalCart" data-bs-toggle="modal">add to cart</button>
                                    <ul class="product-action position-absolute top-0 pt-3 end-0 pe-3">
                                        <li class="bg-white mb-3 rounded-circle d-flex justify-content-center align-items-center">
                                            <a class="text-dark" href="#">
                                                <i class="fa-regular fa-heart"></i>
                                            </a>
                                        </li>
                                        <li class="nth-2 bg-white mb-3 rounded-circle d-flex justify-content-center align-items-center">
                                            <a class="text-dark rotate-90" href="#">
                                                <i class="fa-solid fa-arrow-right-arrow-left"></i>

                                            </a>
                                        </li>
                                        <li class="nth-3 bg-white mb-3 rounded-circle d-flex justify-content-center align-items-center">
                                            <a class="text-dark" href="#">
                                                <i class="fa-solid fa-eye"></i>
                                            </a>
                                        </li>
                                    </ul>
                                    <ul class="product-label position-absolute top-0 pt-3 start-0 ps-3">
                                        {{#isPositive this.discount}}
                                        <p class="label label--discount text-uppercase">-{{convertToPercent this.discount}}%</p>
                                        {{/isPositive}}
                                        {{#if this.hot}}
                                        <p class="label label--hot text-uppercase">hot</p>
                                        {{/if}}
                                        {{#if this.new}}
                                        <p class="label label--new text-uppercase">new</p>
                                        {{/if}}
                                    </ul>
                                </div>
                                <div class="product--content pt-4">
                                    <h6 class="product--name text-uppercase text-center">{{this.category}}</h6>
                                    <a href="#" class="product--desc text-uppercase text-center">{{this.name}}</a>
                                    <p class="text-center">
                                        <span class="pe-1 fs-5 fw-bold product--price">${{calcCurrentPrice this.cost this.discount}}</span>
                                        {{#isPositive this.discount}}
                                        <span><del>${{this.cost}}</del></span>
                                        {{/isPositive}}
                                    </p>
                                </div>
                            </div>
                        </div>
                        {{/each}}
                    </div>
                    <div class="pagination mt-4 mb-5 d-flex justify-content-center ">
                        <a href="#" style="height: 40px; width: 40px;" class=" d-flex justify-content-center align-items-center bg--white--hover border--primary text-decoration-none color--light lh-1 d-inline-block me-2"><i class="fa-solid fa-arrow-left-long fs-13"></i></a>
                        <a href="#" style="height: 40px; width: 40px;" class="active d-flex justify-content-center align-items-center bg--white--hover border--primary text-decoration-none color--light lh-1 d-inline-block me-2">1</a>
                        <a href="#" style="height: 40px; width: 40px;" class=" d-flex justify-content-center align-items-center bg--white--hover border--primary text-decoration-none color--light lh-1 d-inline-block me-2">2</a>
                        <a href="#" style="height: 40px; width: 40px;" class=" d-flex justify-content-center align-items-center bg--white--hover border--primary text-decoration-none color--light lh-1 d-inline-block me-2"><i class="fa-solid fa-arrow-right-long fs-13 "></i></a>
                    </div>
                </div>
            </div>
        </div>
    </div>    
</div>
</div>
<script>
    $(".add-to-cart").click((e) => {
        if($( "#cart--container" ).hasClass("d-none")) {
            $('#cart--container').removeClass("d-none");
        }
        if($('#cart-noProduct').length === 1) {
            $('#cart-noProduct').addClass("d-none");
        }
        var total = 0;
        var isFound = false;
        var product_id = $(e.target).data('id');
        var product_name = $(e.target).parent().parent().children("div.product--content").children("a.product--desc").text();
        var product_price = parseInt(($(e.target).parent().parent().children("div.product--content").children("p").children("span.product--price").text()).replace("$", ""));
        var product_image = $(e.target).parent().children("a").children("img").attr("src");
        $('#cartQuantity').html(`${parseInt($('#cartQuantity').text()) + 1}`);
        $('.cartQuantity').html(`${parseInt($('.cartQuantity').text()) + 1}`);
        for(const cartItem of $('.cart--items')) {
            if(cartItem.dataset.id === product_id) {
                cartItem.querySelector('.product__items--quantify').innerText = parseInt(cartItem.querySelector('.product__items--quantify').innerText) + 1;     
                isFound = true;
            }
            total += parseInt(cartItem.querySelector('.product__items--quantify').innerText) * parseInt((cartItem.querySelector('.product__items--price').innerText).replace("$", ""));
        }
        if(!isFound) {
            if($('.cart--list').length === 0) {
                $('#cart--container').append(`
                    <ul id="scroll-custom" style="overflow-y: overlay;" class="p-0 m-0 flex-grow-1 cart--list"></ul>
                    <div class="pt-4 w-100 border-top-primary cart--submit border-bottom-primary pb-4">
                            <p class="d-flex justify-content-between align-items-center">
                                <span>Subtotal:</span>
                                <span class=" fw-bold" id="subTotal">${{calcTotal session.carts}}</span>
                            </p>    
                            <button type="submit" class="btn--primary btn--light text-white text-uppercase border-0 pt-2 pb-2 w-100 mb-2">Check out</button>
                            <a class="text-center w-100 d-block color--light" href="/cart">View cart</a>
                    </div>
                `);
            }
            $('.cart--list').append(`
                <li class="pb-4 cart--items" data-id="${product_id}">
                    <div class="product__items d-flex align-items-center position-relative overflow-hidden">
                        <div class="product__items--img">
                            <img class="w-100 h-100" src="${product_image}" alt="">
                        </div>
                        <div class="product__items--content ms-3 me-4">
                            <a href="#" class="mb-2 text-decoration-none product__items--name">${product_name}</a>
                            <p class="m-0">
                                <span class="product__items--quantify">1</span> x
                                <span class="product__items--price">$${product_price}</span>
                            </p>
                        </div>
                        <a class="btn-delete clear--product position-absolute top-50 end-0 color--light" href="#" >
                            <i class="fa-regular fa-trash-can" data-id="${product_id}"></i>
                        </a>
                    </div>
                </li>
            `)
            total += product_price;
        }
        $('#subTotal').html(`$${total}`);
        if($('#user_id').val() === undefined) {
            const carts = JSON.parse(localStorage.getItem('cart')) ?? [];
            const product = {
                product_id: product_id,
                product_image: product_image,
                product_name: product_name,
                product_price: product_price,
                quantify: 1,
            }
            const checkProductExist = carts.find((cart) => cart.product_name === product.product_name);
            if(checkProductExist === undefined) {
                carts.push(product);
            }else {
                checkProductExist.quantify += 1; 
            }
            localStorage.setItem('cart', JSON.stringify(carts))
        } else {
            $.ajax({
                url: '/cart/add-to-cart/' + product_id,
                type: 'POST',
                data: {
                    product_id: product_id,
                    user_id: $('#user_id').val(),
                    quantify: 1,
                    total_price: {type: Number, default: 0},
                },
                success: function(response) {
                }
            });
        }
    });
</script>